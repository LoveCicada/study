
#### gdb debug coredump

- `update`
```
https://github.com/LoveCicada/test/blob/master/gdb/gdb-coredump/gdb-coredump.md
```

- `test example`
```

```

- `如何记录coredump`
1. `检查是否开启`
```
在终端中输入ulimit -c, 如果输出为0, 代表未开始记录
dyf@DESKTOP-UACRMUS:/mnt/d/$ ulimit -c
0
```
2. `开启`
```
想要持久化生效, 可修改/etc/profile文件
在profile文件中添加ulimit -c unlimited
sudo vim /etc/profile
# record coredump
ulimit -c unlimited

想要立即生效
输入如下命令，或者sudo reboot重启
source /etc/profile

再次输入ulimit -c, 如果不为0, 则代表开启
```
2. `指定生成文件的路径和名字`
```
当前测试时, 设置的路径为: /mnt/d/code/private/loveCicada_test/gdb/gdb-coredump/bin

需要修改/etc/sysctl.conf系统配置文件, 添加下列内容
# set coredump path and name
kernel.core_pattern=/mnt/d/code/private/loveCicada_test/gdb/gdb-coredump/bin/core_%t_%e_%h_%u_%p_%s
kernel.core_uses_pid=0

加载配置, 用如下命令, 或者重启sudo reboot
sudo sysctl -p /etc/sysctl.conf

```
- `core_pattern的命名参数`
```
%c 转储文件的大小上限
%e 所dump的文件名
%g 所dump的进程的实际组ID
%h 主机名
%p 所dump的进程PID
%s 导致本次coredump的信号
%t 转储时刻(由1970年1月1日起计的秒数)
%u 所dump进程的实际用户I
```
3. `测试`
```
运行程序, 生成core文件
core_1642820935_test-debug_DESKTOP-UACRMUS_1000_2706_11

发现生成的文件大小为0, 查阅资料后得知，与挂在在Windows分区路径有关。
换用Linux根目录测试, /home/dyf/test/corefile

# set coredump path and name
kernel.core_pattern=/home/dyf/test/corefile/core_%t_%e_%h_%u_%p_%s
kernel.core_uses_pid=0

再次执行
sudo sysctl -p /etc/sysctl.conf

测试时, 发现在`/home/dyf/test/corefile/`目录下生成core文件

还存在一个问题：系统重启后, sysctl.conf未自动加载
需要手动加载sudo sysctl -p /etc/sysctl.conf
```

- `gdb 调试coredump`
```
可以将生成的core文件拷贝到当前程序目录下, 或者在gdb时链接找到对应的路径。
cp /home/dyf/test/corefile/core_1642826738_test-debug_DESKTOP-UACRMUS_1000_572_11 ./

1. Debug
--------------------------------------------------------
查看程序崩溃时的堆栈信息
gdb ./test-debug core_1642820935_test-debug_DESKTOP-UACRMUS_1000_2706_11
Reading symbols from ./test-debug...
[New LWP 573]
[New LWP 572]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `./test-debug'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000562a2b70362d in MyTest::Do (this=0x7ffea464748f) at test.cpp:30
30              *p = 1;
[Current thread is 1 (Thread 0x7f8ab7914700 (LWP 573))]

--------------------------------------------------------


--------------------------------------------------------
查看当前栈的变量
(gdb) info locals
nCount = 0
p = 0x0
--------------------------------------------------------


2. Release
release库调试未有详细的堆栈符号信息


```

- `gdb调试时查看对应源码`
```
gdb ./test-debug core_1642826738_test-debug_DESKTOP-UACRMUS_1000_572_11 -tui
```

- `效果`
```
┌──test.cpp────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│   23                  while(nCount>0)                                                                                                                                                                        │
│   24                  {                                                                                                                                                                                      │
│   25                      std::cout << nCount << " the process will break..." << "\n";                                                                                                                       │
│   26                      std::this_thread::sleep_for(std::chrono::seconds(1));                                                                                                                              │
│   27                      --nCount;                                                                                                                                                                          │
│   28                  }                                                                                                                                                                                      │
│   29                  int* p = nullptr;                                                                                                                                                                      │
│  >30                  *p = 1;                                                                                                                                                                                │
│   31              }                                                                                                                                                                                          │
│   32                                                                                                                                                                                                         │
│   33          };                                                                                                                                                                                             │
│   34                                                                                                                                                                                                         │
│   35          void test()                                                                                                                                                                                    │
│   36          {                                                                                                                                                                                              │
│   37              MyTest mt;                                                                                                                                                                                 │
│   38              std::thread t(&MyTest::Do,&mt);                                                                                                                                                            │
│   39              if(t.joinable()){                                                                                                                                                                          │
│   40                  t.join();                                                                                                                                                                              │
│   41              }                                                                                                                                                                                          │
│   42          }                                                                                                                                                                                              │
│   43                                                                                                                                                                                                         │
│   44          int main(int argc, char* argv[])                                                                                                                                                               │
│   45          {                                                                                                                                                                                              │
│   46              test();                                                                                                                                                                                    │
│   47                                                                                                                                                                                                         │
│   48              return 0;                                                                                                                                                                                  │
│   49          }                                                                                                                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
multi-thre Thread 0x7f8ab79147 In: MyTest::Do                                                                                                                                          L30   PC: 0x562a2b70362d
[New LWP 573]
[New LWP 572]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
--Type <RET> for more, q to quit, c to continue without paging--
Core was generated by `./test-debug'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000562a2b70362d in MyTest::Do (this=0x7ffea464748f) at test.cpp:30
[Current thread is 1 (Thread 0x7f8ab7914700 (LWP 573))]
(gdb)
```